---
title: Github Actionのworkflowをローカルでテストしてみた。
tags:
  - GitHub
  - GitHubActions
private: false
updated_at: '2024-04-23T11:40:34+09:00'
id: c131fda97d8493809581
organization_url_name: null
slide: false
ignorePublish: false
---
# これは何？
　Github Actionのための workflowをローカルでテストする方法のまとめ。

## Goal

- GutHub Actionsを作成して、CI / CDを自動化する。
- そのために作成した、Github Actionsをデバッグする。
    - Github上でもできなくはないが、間違えるたびにコミットすることになり、コミットログが見づらくなる。

## やったこと

`nectos/act` というパッケージがあるため使用してみた。

公式: https://nektosact.com/introduction.html

- GutHub Actionsのworkflowをlocalで動かすことができるツール。
- Dockerを使って、模擬的に　Github workflowsを動かすことができる。

以下はMac M1での実行。

### Install

```
brew install act
```

### workflows実行コマンド

```
act pull_request -W ".github/workflows/unittest.yml" -P ubuntu-20.04=catthehacker/ubuntu:act-20.04 --container-architecture linux/amd64 —env-file .env.local
```

- act XXX の XXXにはトリガーを指定する。
- -W にて実行ファイルパスを明示的に指定できる。
- -P を指定しないと defaultでnodeになってしまいエラーとなったため、Ubuntuを明示的に指定。
- Mac M1の場合、 `--container-architecture` Flagが必要。
- 環境変数は Defaultで `.env` が読み込まれるため、明示的に指定
    - GitHubでは、RepositoryのSecretsに設定し、workflow内にて `[secrets.XXX](http://secrets.XXX)` として引用
    

### コード例

``` .github/workflows/unittest.yml
name: Run Unit Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      max-parallel: 4

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.9.6
        uses: actions/setup-python@v5
        with:
          python-version: '3.9.6'
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools==57.4.0 wheel
          pip install -r deploy/requirements/local.txt
      - name: Run Tests
        # このenvはGithub上で実行する時のみ使うため、コメントアウト。
        # localでテストする際は、実行コマンドで環境変数定義ファイルを指定する。
        #env:
        #ELASTIC_URL: ${{ secrets.ELASTIC_URL }}
        #LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          ./run test-all-ci
```

```.env.local
LINE_CHANNEL_ACCESS_TOKEN="XXXXXXX"
ELASTIC_URM="http://127.0.0.1:9200"
```
