---
title: AWS CDK workshopでAWS Code commitの代わりにGitHubを使用する方法
tags:
  - AWS
  - CodePipeline
  - CDK
private: false
updated_at: '2024-12-15T12:27:46+09:00'
id: 84783bc85fa99968e2e8
organization_url_name: null
slide: false
ignorePublish: false
---
## これは何？
AWS CDKワークショップの `高度なトピック (オプション)` にて、AWS CodeCommitを使用して、Pipelineを作成する項目がある。しかし、AWS CodeCommitはサービスの新規提供が終了し、新規の利用ができない状態。(2024年12月現在)
そのため、代わりにGitHubを使用して、Pipelineを構築する方法。


## TL;DR
- CodeCommit自体はコードRepositoryのため、GitHubにて代用が可能。GitHubのRepositoryを作成し、コードをpushする
- AWS developer toolsの[Connections](https://ap-northeast-1.console.aws.amazon.com/codesuite/settings/connections?region=ap-northeast-1) にて、GitHubとの接続を設定する
- 発行されるARNを利用して、Pipeline設定を行う

AWS CDK workshop自体は[こちら](https://catalog.us-east-1.prod.workshops.aws/workshops/10141411-0192-4021-afa8-2436f3c66bd8/ja-JP)

## 前提
workshopを進めていくと、 `高度なトピック (オプション) > CDK Pipelines > リポジトリの作成` にてエラーとなる。
原因として、AWS CodeCommitの新規利用が停止されているため。[公式Blog](https://aws.amazon.com/jp/blogs/devops/how-to-migrate-your-aws-codecommit-repository-to-another-git-provider/)

## 手順

#### GitHubとの接続設定
GitHubのRepositoryを作成し、コードをコミット、プッシュする。

AWSコンソールにLoginし、Developer Toolsの[Settings>Connections](https://ap-northeast-1.console.aws.amazon.com/codesuite/settings/connections?region=ap-northeast-1)に移動。
![スクリーンショット 2024-12-15 12.12.02.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/386347/c9a9856f-4155-71d9-6276-9554501f5cee.png)

`Create Connections`から接続先: GitHub、任意の名前を入力し、接続を選択。
初めて利用する場合は、GitHubにリダイレクトされ、必要なAppをInstallすることになる。

次に接続設定を行う。`Install new App` を選択する。GitHubにリダイレクトし、接続するRepositoryを選択することになる。
![スクリーンショット 2024-12-15 12.15.45.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/386347/9d58760f-2703-cad3-dd56-254afe064595.png)

接続が終わると、Connectionsが新規作成されている。

#### GitHubとの接続を利用した、Pipeline設定

workshopのコードにて、CodeCommitを作成するコードを削除し、Pipelineの

```diff_python
from aws_cdk import Stack
from aws_cdk import pipelines as pipelines
from constructs import Construct


class WorkshopPipelineStack(Stack):

    def __init__(self, scope: Construct, id: str, **kwargs) -> None:
        super().__init__(scope, id, **kwargs)

-        # Creates a CodeCommit repository called 'WorkshopRepo'
-        repo = codecommit.Repository(
-            self, "WorkshopRepo", repository_name="WorkshopRepo"
-        )

        pipeline = pipelines.CodePipeline(
            self,
            "Pipeline",
            synth=pipelines.ShellStep(
                "Synth",
-               input=pipelines.CodePipelineSource.code_commit(repo, "main"),
+                input=pipelines.CodePipelineSource.connection(
+                    "{GitHub user名}/{GitHub Repository名}",
+                    "{branch名}",
+                    connection_arn="arn:aws:codeconnections:...(connectionsで作成されたARN)",
                ),
                commands=[
                    "npm install -g aws-cdk",
                    "pip install -r requirements.txt",
                    "cdk synth",
                ],
            ),
        )
```

チュートリアルどうりに以下のコマンドを実行。
```
git commit -am "MESSAGE" && git push
cdk deploy
```

CodePipelineを確認し、作成されていることを確認する。
